# 股指期货跨期套利策略

## 策略概述

本策略是一个基于统计套利的股指期货跨期价差交易系统，通过监控近月与次月合约之间的价差偏离程度，在价差极端时建立套利头寸，并在价差回归时平仓获利。策略采用真实Tick级信号延时机制，模拟实盘交易中的延迟执行情况。

### 适用品种
- IF (沪深300股指期货)
- IM (中证1000股指期货)  
- IH (上证50股指期货)
- IC (中证500股指期货)

## 核心策略逻辑

### 1. 价差统计与Z-Score计算
- **滑动窗口**：使用120根K线（即120分钟/2小时）的历史数据
- **价差计算**：`spread = 近月价格 - 次月价格`
- **Z值计算**：`Z = (当前价差 - 均值) / 标准差`

### 2. 开仓逻辑
**触发条件**：
- `|Z| > K_OPEN (2.0)` - 价差偏离超过2倍标准差
- 价格不同性检查：与上次开仓价差相差至少0.5点
- 保证金充足：开仓后占用不超过总权益的70%

**方向选择**：
- Z > 0 (价差过高) → 做空价差 (卖近月 + 买次月)
- Z < 0 (价差过低) → 做多价差 (买近月 + 卖次月)

**动态手数**：根据信号强度调整开仓手数
| Z值范围 | 开仓手数 | 信号强度 |
|---------|---------|---------|
| \|Z\| ≥ 3.5 | 21手 | 极强 |
| \|Z\| ≥ 3.0 | 20手 | 强 |
| \|Z\| ≥ 2.5 | 19手 | 中强 |
| \|Z\| ≥ 2.0 | 18手 | 基础 |

### 3. 锁仓逻辑 (T+0当天浮盈保护)
**触发条件**：
- 开仓当天 (T+0)
- `|Z| < K_LOCK (0.3)` - 价差已明显回归
- 浮盈点数 ≥ LOCK_MIN_PNL_POINTS × 手数 (至少1点/手)
- 保证金充足：锁仓后总占用不超过85%

**执行动作**：开立反向头寸，锁定当日浮盈，防止盘中回撤

### 4. 平仓逻辑

#### 4.1 均值回归平仓 (T+1及以后)
**触发条件**：
- 非开仓当天
- 价差已回归：
  - 多头价差 (direction=1)：Z ≥ 0
  - 空头价差 (direction=-1)：Z ≤ 0
- `|Z| < K_LOCK (0.3)` - 回归充分

#### 4.2 解锁平仓 (锁仓后)
**触发条件**：
- 已锁仓状态
- 锁仓次日 (T+1)
- 价差再次极端偏离：
  - Z > K_OPEN (2.0) → 平多头，保留空头
  - Z < -K_OPEN (-2.0) → 平空头，保留多头

### 5. 换月机制
- **触发时间**：距离近月合约到期前1天
- **执行动作**：
  1. 强平所有持仓
  2. 将原次月设为新近月
  3. 订阅新的次月合约
  4. 重置所有状态变量

## 特色功能

### Tick级信号延时 (15-Tick Delay)
模拟实盘中信号触发到实际执行之间的延迟：
- **实现方式**：每次`api.wait_update()`计数+1
- **延时设置**：15个市场更新tick
- **影响范围**：所有信号类型（开仓/锁仓/平仓）
- **跟踪记录**：导出CSV对比触发时与执行时的Z值变化

### 重复订单防护 (三重检查)
1. **历史开仓价格检查**：与上次开仓价差对比
2. **待执行队列检查**：防止队列中存在相似信号
3. **当前持仓检查**：防止相同方向相似价格的重复开仓

### 保证金分级管理
| 阶段 | 最大占用比例 | 用途 |
|------|-------------|------|
| 开仓 | 70% | 预留20%空间用于后续锁仓 |
| 锁仓 | 85% | 锁定浮盈，留5%缓冲 |
| 总限制 | 90% | 系统极限保护 |

## 技术参数

### 全局配置
```python
WINDOW = 120              # 统计窗口：120根1分钟K线
BAR_SEC = 60             # K线周期：60秒
K_OPEN = 2.0             # 开仓Z值阈值
K_LOCK = 0.3             # 锁仓/平仓Z值阈值
LOCK_MIN_PNL_POINTS = 1  # 最小锁仓盈利点数
BASE_LOTS = 18           # 基础开仓手数
```

### 回测参数
```python
START_DATE = date(2025, 6, 1)
END_DATE = date(2025, 12, 31)
init_balance = 10,000,000  # 初始资金1000万元
```

## 输出文件

策略运行后会自动生成以下统计文件：

### 1. spread_lock_4idx_backtest_close_logs.csv
平仓明细，包含：
- 品种、方向、开仓时间、平仓时间
- 入场/出场价差
- 盈亏点数、持仓K线数、手续费
- 平仓原因 (均值回归/换月/解锁等)

### 2. spread_lock_4idx_backtest_event_logs.csv
时间轴事件流水，包含：
- 所有开仓、锁仓、平仓事件
- 执行时间、价差、盈亏、手数
- 便于分析策略行为时序

### 3. signal_delay_comparison.csv  
信号延时对比分析，包含：
- 信号触发时间 vs 实际执行时间
- 触发时Z值 vs 执行时Z值
- Z值变化量、是否满足执行条件
- 实际成交手数
- **关键用途**：评估延时对策略表现的影响

### 4. 图表输出
- **权益曲线 + 保证金占用**：equity_and_position.png
- **回撤曲线**：drawdown_curve.png
- **开仓|Z|值分布**：z_distribution.png

## 绩效指标

策略会自动计算并输出：
- **总收益率** = (最终权益 - 初始资金) / 初始资金
- **最大回撤** = max((峰值 - 当前) / 峰值)
- **夏普比率** = 年化收益 / 年化波动率 × √(252×240) 
- **胜率** = 盈利交易数 / 总交易数
- **平均持仓K线数**
- **单笔平均盈亏**
- **盈亏稳定性** = 平均盈亏 / 盈亏标准差

## 使用方法

### 环境要求
```bash
pip install tqsdk numpy matplotlib
```

### 运行策略
```python
python 股指期货跨期套利.py
```

### 修改配置
编辑文件顶部全局配置区域：
- `UNIVERSE`: 选择交易品种
- `START_DATE` / `END_DATE`: 回测时间区间  
- `K_OPEN` / `K_LOCK`: 调整开仓/平仓敏感度
- `BASE_LOTS` / `LOTS_BY_SIGNAL`: 调整手数配置

## 风险提示

1. **滑点风险**：中金所不支持市价单，策略使用限价单逐档吃单，可能存在未完全成交情况
2. **保证金风险**：极端行情下保证金占用可能超预期，策略已设置多层保护
3. **换月风险**：合约到期前强制平仓，可能在不利价格平仓
4. **模型假设**：策略假设价差均值回归，极端趋势行情可能失效
5. **延时影响**：真实环境延时可能大于回测设定的15 tick

## 策略逻辑流程图

```
市场更新 (Tick+1)
    ↓
计算当前价差 & Z值
    ↓
处理待执行延时信号队列 (检查是否已延时15 tick)
    ↓
开仓信号检测 (|Z| > 2.0)
    ├─ 三重防重复检查
    └─ 添加到延时队列 (15 tick后执行)
    ↓
锁仓信号检测 (T+0, |Z| < 0.3, 有浮盈)
    └─ 添加到延时队列 (15 tick后执行)
    ↓
平仓信号检测 (T+1+, 价差回归, |Z| < 0.3)
    └─ 添加到延时队列 (15 tick后执行)
    ↓
解锁信号检测 (T+1+, |Z| > 2.0)
    └─ 根据方向选择平仓哪条腿
    ↓
换月检测 (距到期<1天)
    └─ 强制平仓所有持仓并换合约
    ↓
记录权益、保证金占用等统计数据
```

## 技术架构

- **交易接口**：TqSDK (天勤量化)
- **回测引擎**：TqBacktest
- **数据周期**：1分钟K线 + Tick级报价
- **信号延时**：基于市场更新次数的Tick计数
- **订单执行**：限价单逐档吃单模拟
- **数据存储**：CSV格式导出

## 版本历史

- **v3.0** - 实现Tick级信号延时与多重防重复开仓
- **v2.0** - 添加动态手数配置与保证金分级管理
- **v1.0** - 基础跨期套利框架

## 作者与许可

本策略仅供学习研究使用，请勿用于实盘交易。使用者需自行承担一切风险。

---

**最后更新**: 2026年2月
